---
- name: Install Gnome Preferences
  hosts: "{{hosts|d(host|d('all'))}}"
  gather_facts: no
 
  vars:
    # Gnome Extension Variables
    # -------------------------
    gp_base: /org/gnome/shell
    gp_key: enabled-extensions
    gp_extension_name_suffix: gnome-shell-extensions.gcampax.github.com
    gp_extension_package_prefix: gnome-shell-extension
    gp_extensions:
      - apps-menu
      - window-list
      - places-menu
      - alternate-tab
      - launch-new-instance
      - top-icons


    # Gnome Desktop Variables
    # -----------------------
    gd_base: /org/gnome/desktop

  environment:
    http_proxy: "{{http_proxy|default(None)}}"

  tasks:
    # Install Gnome Extensions
    # ------------------------
    - name: Install Gnome Extensions
      yum:
        name: "{{gp_extension_package_prefix}}-{{item}}"
        state: present
      with_items: "{{gp_extensions}}"

    - name: Generate Gnome dconf Setting
      set_fact:
        gp_value: >-
          "[
          {%- for gp_extension in gp_extensions -%}
          '{{gp_extension}}@{{gp_extension_name_suffix}}'
          {%- if not loop.last -%},{%- endif -%}
          {%- endfor -%}
          ]"

    - name: Enable Gnome Extensions
      shell: |
        dbus-launch dconf write {{gp_base}}/{{gp_key}} {{gp_value}}
        dbus-launch dconf update
      become: true
      become_user: admin


    # Disable Lock Screen 
    # -------------------
    - name: Disable Lock Screen
      shell: |
        dbus-launch dconf write {{gd_base}}/lockdown/disable-lock-screen true
        dbus-launch dconf update
      become: true
      become_user: admin


    # Disable Screen Saver Lock
    # -------------------------
    - name: Disable Screen Saver Lock
      shell: |
        dbus-launch dconf write {{gd_base}}/screensaver/lock-enabled false
        dbus-launch dconf update
      become: true
      become_user: admin


    # Disable Session Idle
    # --------------------
    - name: Disable Session Idle
      shell: |
        dbus-launch dconf write {{gd_base}}/session/idle-delay 0
        dbus-launch dconf update
      become: true
      become_user: admin


    # Disable Power Savings
    # --------------------
    - name: Disable Power Savings
      shell: |
        dbus-launch dconf write /org/gnome/settings-daemon/plugins/power/active false
        dbus-launch dconf update
      become: true
      become_user: admin



    # Show Desktop Icons
    # ------------------
    - name: Enable Desktop Icons
      shell: |
        dbus-launch dconf write {{gd_base}}/background/show-desktop-icons true
        dbus-launch dconf update
      become: true
      become_user: admin


    # Show Top Bar Date
    # -----------------
    - name: Enable Top Bar Date
      shell: |
        dbus-launch dconf write {{gd_base}}/interface/show-desktop-icons true
        dbus-launch dconf update
      become: true
      become_user: admin


    # Show Clock Date
    # ---------------
    - name: Enable Clock Date
      shell: |
        dbus-launch dconf write {{gd_base}}/interface/clock-show-date true
        dbus-launch dconf update
      become: true
      become_user: admin


    # Enable Maximize, Minimize, and Close Buttons
    # --------------------------------------------
    - name: Enable Maximize, Minimize, and Close Buttons
      shell: |
        dbus-launch dconf write {{gd_base}}/wm/preferences/button-layout \"'appmenu:minimize,maximize,close'\"
        dbus-launch dconf update
      become: true
      become_user: admin


    # Enable Automatic Login
    # ----------------------
    - name: Enable Gnome Automatic Login
      lineinfile:
        path: /etc/gdm/custom.conf
        # regexp: ^\[daemon\]$
        insertafter: ^\[daemon\]$
        line: |-
          AutomaticLoginEnable=True
          AutomaticLogin=admin
        state: present
